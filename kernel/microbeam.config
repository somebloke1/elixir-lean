# MicroBEAM Kernel Configuration Fragment
# Apply on top of tinyconfig: make tinyconfig && make menuconfig
# Then apply this fragment: scripts/kconfig/merge_config.sh .config microbeam.config

# Essential Architecture Support
CONFIG_64BIT=y
CONFIG_X86_64=y
CONFIG_OUTPUT_FORMAT="elf64-x86-64"
CONFIG_SMP=y
CONFIG_NR_CPUS=8

# Core kernel features
CONFIG_EXPERT=y
CONFIG_EMBEDDED=y
CONFIG_OPTIMIZE_FOR_SIZE=y
CONFIG_CC_OPTIMIZE_FOR_SIZE=y

# Required for BEAM/Erlang
CONFIG_MMU=y
CONFIG_FUTEX=y
CONFIG_EPOLL=y
CONFIG_EVENTFD=y
CONFIG_SYSVIPC=y
CONFIG_POSIX_TIMERS=y
CONFIG_HIGH_RES_TIMERS=y

# Process and memory management
CONFIG_FORK=y
CONFIG_VMAP_STACK=y
CONFIG_MEMCG=y
CONFIG_PROC_FS=y
CONFIG_SYSFS=y

# Executable formats
CONFIG_BINFMT_ELF=y
CONFIG_BINFMT_SCRIPT=y

# TTY and console (minimal)
CONFIG_TTY=y
CONFIG_VT=y
CONFIG_VT_CONSOLE=y
CONFIG_UNIX98_PTYS=y
CONFIG_SERIAL_8250=y
CONFIG_SERIAL_8250_CONSOLE=y

# Essential filesystems
CONFIG_EXT4_FS=y
CONFIG_TMPFS=y
CONFIG_TMPFS_POSIX_ACL=y
CONFIG_HUGETLBFS=y
CONFIG_DEVTMPFS=y
CONFIG_DEVTMPFS_MOUNT=y

# Networking (minimal for Elixir)
CONFIG_NET=y
CONFIG_PACKET=y
CONFIG_UNIX=y
CONFIG_INET=y
CONFIG_IPV6=y
CONFIG_NETDEVICES=y

# VirtIO drivers (VM-specific)
CONFIG_VIRTIO=y
CONFIG_VIRTIO_MENU=y
CONFIG_VIRTIO_PCI=y
CONFIG_VIRTIO_PCI_LEGACY=y
CONFIG_VIRTIO_BALLOON=n
CONFIG_VIRTIO_BLK=y
CONFIG_VIRTIO_NET=y
CONFIG_VIRTIO_CONSOLE=y
CONFIG_HW_RANDOM_VIRTIO=y

# SCSI support for VirtIO block
CONFIG_SCSI=y
CONFIG_BLK_DEV_SD=y
CONFIG_SCSI_VIRTIO=y

# Paravirtualization
CONFIG_PARAVIRT=y
CONFIG_PARAVIRT_SPINLOCKS=y
CONFIG_KVM_GUEST=y
CONFIG_ARCH_CPUIDLE_HALTPOLL=y

# Block layer
CONFIG_BLOCK=y
CONFIG_LBDAF=y
CONFIG_BLK_DEV=y
CONFIG_BLK_DEV_LOOP=y

# Disable unnecessary features
CONFIG_MODULES=n
CONFIG_MODULE_UNLOAD=n
CONFIG_MODVERSIONS=n
CONFIG_BLK_DEV_INITRD=y
CONFIG_INITRAMFS_SOURCE=""
CONFIG_RD_GZIP=y
CONFIG_RD_BZIP2=n
CONFIG_RD_LZMA=n
CONFIG_RD_XZ=y
CONFIG_RD_LZO=n
CONFIG_RD_LZ4=n

# Security (minimal)
CONFIG_SECURITY=n
CONFIG_SECURITYFS=n
CONFIG_SECURITY_NETWORK=n
CONFIG_SECURITY_PATH=n
CONFIG_LSM="lockdown,yama,loadpin,safesetid,integrity"

# No swap support
CONFIG_SWAP=n

# Compression
CONFIG_KERNEL_GZIP=n
CONFIG_KERNEL_XZ=y

# Power management (disabled)
CONFIG_SUSPEND=n
CONFIG_HIBERNATION=n
CONFIG_PM=n

# Disable debug features
CONFIG_DEBUG_KERNEL=n
CONFIG_DEBUG_INFO=n
CONFIG_FRAME_POINTER=n
CONFIG_STACKTRACE=n
CONFIG_FTRACE=n
CONFIG_KPROBES=n
CONFIG_PROFILING=n

# Disable unused hardware support
CONFIG_PCI=y
CONFIG_USB_SUPPORT=n
CONFIG_SOUND=n
CONFIG_WLAN=n
CONFIG_WIRELESS=n
CONFIG_RFKILL=n
CONFIG_INPUT=n
CONFIG_SERIO=n
CONFIG_VT_HW_CONSOLE_BINDING=n
CONFIG_LEGACY_PTYS=n
CONFIG_DEVMEM=n

# Crypto (minimal for BEAM)
CONFIG_CRYPTO=y
CONFIG_CRYPTO_ALGAPI=y
CONFIG_CRYPTO_HASH=y
CONFIG_CRYPTO_SHA256=y
CONFIG_CRYPTO_AES=y
CONFIG_CRYPTO_GCM=y

# printk support (can disable for production)
CONFIG_PRINTK=y
CONFIG_PRINTK_TIME=y
CONFIG_MESSAGE_LOGLEVEL_DEFAULT=4

# Command line
CONFIG_CMDLINE_BOOL=y
CONFIG_CMDLINE="console=ttyS0,115200 quiet init=/sbin/beam-init"